<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- 基本 SEO -->
  <title>文章內容｜China Explore</title>
  <meta name="description" content="中國美食與景點實地體驗筆記，包含交通、價位、推薦菜式與拍攝照片。" />
  <link rel="canonical" id="canonicalLink" href="" />

  <!-- Open Graph / Twitter（動態注入內容後會覆寫） -->
  <meta property="og:type" content="article" />
  <meta property="og:title" id="ogTitle" content="文章內容｜China Explore" />
  <meta property="og:description" id="ogDesc" content="中國美食與景點實地體驗筆記。" />
  <meta property="og:image" id="ogImg" content="/assets/cover.jpg" />
  <meta property="og:url" id="ogUrl" content="" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" id="twTitle" content="文章內容｜China Explore" />
  <meta name="twitter:description" id="twDesc" content="中國美食與景點實地體驗筆記。" />
  <meta name="twitter:image" id="twImg" content="/assets/cover.jpg" />

  <!-- AdSense（與首頁一致） -->
  <meta name="google-adsense-account" content="ca-pub-7165265186193287" />
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7165265186193287" crossorigin="anonymous"></script>

  <!-- 站內樣式 -->
  <link rel="stylesheet" href="/style.css" />

  <style>
    /* 文章頁專屬樣式：乾淨、可讀性高 */
    body{background:#f8fafc;color:#111827;line-height:1.7}
    .wrap{max-width:860px;margin:0 auto;padding:20px}
    .breadcrumbs{font-size:14px;color:#6b7280;margin:8px 0 6px}
    .breadcrumbs a{color:#2563eb;text-decoration:none}
    .hero{border-radius:12px;overflow:hidden;margin:12px 0 16px;background:#fff}
    .hero img{width:100%;height:auto;object-fit:cover;display:block}
    h1{font-size:28px;margin:6px 0 10px}
    .meta{font-size:14px;color:#6b7280;margin-bottom:14px}
    .tags{margin:8px 0;display:flex;gap:8px;flex-wrap:wrap}
    .tag{font-size:12px;background:#eef2ff;border:1px solid #c7d2fe;color:#3730a3;border-radius:999px;padding:2px 8px}
    .article{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px}
    .article p{margin:12px 0}
    .article h2{font-size:20px;margin:18px 0 8px}
    .cta-row{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
    .btn{display:inline-block;border:1px solid #d1d5db;border-radius:8px;padding:10px 12px;background:#fff;color:#111827;text-decoration:none}
    .btn.primary{background:#111827;color:#fff;border-color:#111827}
    .author{margin-top:18px;padding:14px;border:1px solid #e5e7eb;border-radius:12px;background:#fafafa;color:#374151;font-size:14px}
    .pager{display:flex;justify-content:space-between;gap:8px;margin:16px 0}
    .pager a{flex:1;text-align:center}
    .related{margin-top:20px}
    .related h3{font-size:18px;margin-bottom:10px}
    .related-list{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media(max-width:980px){.related-list{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.related-list{grid-template-columns:1fr}}
    .rel-card{border:1px solid #e5e7eb;border-radius:10px;overflow:hidden;background:#fff}
    .rel-thumb{aspect-ratio:16/10;background:#f1f5f9}
    .rel-thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .rel-body{padding:8px}
    .rel-title{font-weight:600;line-height:1.35;font-size:14px}
    footer{margin-top:28px;padding:18px 0;border-top:1px solid #e5e7eb;color:#6b7280;font-size:14px}
    .topnav{margin-bottom:8px}
  </style>

  <!-- 固定麵包屑 JSON-LD（會在載入內容後再動態補 BlogPosting） -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"BreadcrumbList",
    "itemListElement":[
      {"@type":"ListItem","position":1,"name":"Home","item":"https://todays-tasks.com/"},
      {"@type":"ListItem","position":2,"name":"China Explore","item":"https://todays-tasks.com/china-explore.html"}
    ]
  }
  </script>
</head>
<body>
  <!-- 與首頁一致的導覽列 -->
  <div class="compliance-links topnav" role="navigation" aria-label="Primary">
    <a href="/index.html">Home</a> |
    <a href="/about.html">About</a> |
    <a href="/contact.html">Contact</a> |
    <a href="/privacy.html">Privacy Policy</a> |
    <a href="/productivity-tips.html">Productivity Tips</a> |
    <a href="/article2.html">Time Management</a> |
    <a href="/article3.html">Digital To-Do Lists</a> |
    <a href="/article4.html">How to Use</a> |
    <a href="/article5.html">Weekly Review</a> |
    <a href="/etsy-guides.html">Time-Saving</a> |
    <a href="/todo.html">To Do List</a>
  </div>

  <main class="wrap" id="contentRoot">
    <nav class="breadcrumbs" aria-label="Breadcrumbs">
      <a href="/index.html">Home</a> › <a href="/china-explore.html">China Explore</a> › <span id="crumbTitle">載入中…</span>
    </nav>

    <article id="postWrap" class="article" hidden>
      <div class="hero" id="hero"></div>
      <h1 id="postTitle">載入中…</h1>
      <div class="meta" id="postMeta"></div>
      <div class="tags" id="postTags"></div>

      <section id="postBody"></section>

      <div class="cta-row" id="authorityRow"></div>

      <div class="author" id="authorBox">
        <strong>作者：</strong>Hill（Today’s Tasks）｜實地踩點與在地體驗筆記。<br>
        文章與照片著作權所有，未經授權請勿轉載或改作（© Today’s Tasks）。
      </div>

      <div class="pager" id="pager"></div>
    </article>

    <section class="related" id="relatedWrap" hidden>
      <h3>延伸閱讀</h3>
      <div class="related-list" id="relatedList"></div>
    </section>

    <div id="status" class="article">載入中…</div>
  </main>

  <footer class="wrap">
    © 2025 Today’s Tasks. All rights reserved.
  </footer>

  <script>
    // === 你的 Google Apps Script JSON 端點 ===
    const FEED_URL = "https://script.google.com/macros/s/AKfycbwq5InzCeyUnW-GHe6bNqReMQMzWvwKe_pAZpD7ONHZ4LZrBdt8lgtpdxu1c57AaPx3ww/exec";

    const params = new URLSearchParams(location.search);
    const targetId = params.get("id");

    const $ = (id) => document.getElementById(id);
    const postWrap = $("postWrap");
    const statusEl = $("status");

    let ALL = [];

    // 啟動
    (async function init(){
      try{
        const res = await fetch(FEED_URL, {cache:"no-cache"});
        const {items=[]} = await res.json();
        ALL = normalize(items);
        if (!targetId){
          statusEl.textContent = "缺少文章 id。";
          return;
        }
        const idx = ALL.findIndex(x => String(x.id) === String(targetId));
        if (idx === -1){
          statusEl.textContent = "找不到這篇文章。";
          return;
        }
        const post = ALL[idx];

        renderPost(post);
        renderPager(idx);
        renderRelated(post);

        // SEO：注入 JSON-LD（BlogPosting）與 og/twitter/canonical
        injectSEO(post);

        statusEl.hidden = true;
        postWrap.hidden = false;
        $("relatedWrap").hidden = false;
      }catch(e){
        statusEl.textContent = "讀取失敗：" + e.message;
      }
    })();

    function normalize(list){
      return list.map(x=>{
        x.id = x.id ?? "";
        x.title = (x.title||"").toString();
        x.city = (x.city||"").toString();
        x.province = (x.province||"").toString();
        x.kind = (x.kind||"").toString();
        x.tags = Array.isArray(x.tags) ? x.tags : (x.tags ? x.tags.toString().split(",").map(s=>s.trim()).filter(Boolean) : []);
        x.image = (x.image||"").toString();
        x.link = (x.link||"").toString();
        x.excerpt = (x.excerpt||"").toString();
        x.content = (x.content||"").toString();
        x.created = x.created ? new Date(x.created) : new Date(0);
        return x;
      }).sort((a,b)=> b.created - a.created); // 以時間排序，利於上一篇/下一篇
    }

    function renderPost(p){
      $("crumbTitle").textContent = p.title || "內容";

      // 圖片（hero）
      $("hero").innerHTML = p.image
        ? `<img src="${escAttr(p.image)}" alt="${escAttr(p.title)}" loading="eager">`
        : "";

      $("postTitle").textContent = p.title;
      $("postMeta").innerHTML = [
        p.city || "",
        p.province || "",
        p.kind || "",
        (p.created && !isNaN(p.created)) ? p.created.toLocaleDateString() : ""
      ].filter(Boolean).join(" · ");

      $("postTags").innerHTML = (p.tags||[]).map(t=>`<span class="tag">#${escHtml(t)}</span>`).join("");

      // 內文：把換行轉成段落（保留你的 Excel 格式）
      const bodyHtml = [p.excerpt, p.content]
        .filter(Boolean)
        .join("\n\n")
        .split(/\n{2,}/)
        .map(seg => `<p>${escHtml(seg).replace(/\n/g,"<br>")}</p>`)
        .join("");
      $("postBody").innerHTML = bodyHtml || "<p>（尚無內容）</p>";

      // 權威外鏈（自動判斷）
      $("authorityRow").innerHTML = buildAuthorityButtons(p)
        + ` <a class="btn" href="/china-explore.html">回到清單</a>`;
    }

    function buildAuthorityButtons(p){
      const q = encodeURIComponent([(p.city||""), p.title].filter(Boolean).join(" "));
      const dp = `https://www.dianping.com/search/keyword/2/0_${q}`;
      const ta = `https://www.tripadvisor.com/Search?q=${q}`;
      // 美食優先大眾點評，其他用 TripAdvisor
      if ((p.kind||"").includes("食")){
        return `<a class="btn primary" href="${dp}" target="_blank" rel="nofollow noopener">權威連結：大眾點評</a>`;
      } else {
        return `<a class="btn primary" href="${ta}" target="_blank" rel="nofollow noopener">權威連結：Tripadvisor</a>`;
      }
    }

    function renderPager(idx){
      const prev = ALL[idx+1];
      const next = ALL[idx-1];
      $("pager").innerHTML = `
        ${prev ? `<a class="btn" href="/post.html?id=${escAttr(prev.id)}">← 上一篇：${escHtml(prev.title)}</a>` : `<span></span>`}
        ${next ? `<a class="btn" href="/post.html?id=${escAttr(next.id)}">下一篇：${escHtml(next.title)} →</a>` : `<span></span>`}
      `;
    }

    function renderRelated(p){
      // 依：同城市 > 同類別 > 標籤交集 取 6 篇
      const base = ALL.filter(x=> String(x.id)!==String(p.id));
      const score = (x)=>{
        let s = 0;
        if (p.city && x.city===p.city) s += 3;
        if (p.kind && x.kind===p.kind) s += 2;
        const inter = (x.tags||[]).filter(t => (p.tags||[]).includes(t)).length;
        s += inter;
        return s;
      };
      const picks = base
        .map(x=>({x, s:score(x)}))
        .filter(o=>o.s>0)
        .sort((a,b)=> b.s - a.s || (b.x.created - a.x.created))
        .slice(0,6)
        .map(o=>o.x);

      $("relatedList").innerHTML = picks.map(x=>`
        <a class="rel-card" href="/post.html?id=${escAttr(x.id)}" aria-label="${escAttr(x.title)}">
          <div class="rel-thumb">
            ${x.image ? `<img src="${escAttr(x.image)}" alt="${escAttr(x.title)}" loading="lazy">` : ""}
          </div>
          <div class="rel-body">
            <div class="rel-title">${escHtml(x.title)}</div>
          </div>
        </a>
      `).join("") || `<div class="article">暫無相關內容</div>`;
    }

    function injectSEO(p){
      const url = location.origin + location.pathname + location.search;
      const title = p.title || "文章內容｜China Explore";
      const desc = p.excerpt || "中國美食與景點實地體驗筆記。";
      const img = p.image || (location.origin + "/assets/cover.jpg");

      $("canonicalLink").href = url;
      $("ogTitle").setAttribute("content", title);
      $("ogDesc").setAttribute("content", desc);
      $("ogImg").setAttribute("content", img);
      $("ogUrl").setAttribute("content", url);
      $("twTitle").setAttribute("content", title);
      $("twDesc").setAttribute("content", desc);
      $("twImg").setAttribute("content", img);

      // BlogPosting JSON-LD（動態）
      const jsonld = {
        "@context":"https://schema.org",
        "@type":"BlogPosting",
        "headline": title,
        "image": img,
        "datePublished": p.created && !isNaN(p.created) ? p.created.toISOString() : undefined,
        "author":{"@type":"Person","name":"Hill"},
        "publisher":{"@type":"Organization","name":"Today's Tasks"},
        "articleSection": p.kind || "",
        "description": desc,
        "mainEntityOfPage": url
      };
      const s = document.createElement("script");
      s.type = "application/ld+json";
      s.textContent = JSON.stringify(jsonld);
      document.head.appendChild(s);
      document.title = title + "｜China Explore";
    }

    // 安全轉義
    function escHtml(s){ return (s||"").replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
    function escAttr(s){ return escHtml(String(s||"")); }
  </script>
</body>
</html>
