<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>中國美食美景分享｜China Explore</title>
  <meta name="description" content="中國內地旅行的美食與美景分享。首頁聚焦單篇 Spotlight，一鍵爽看；支援城市、省份、類別與標籤篩選，圖片不裁切自適應顯示。"/>

  <link rel="stylesheet" href="/style.css"/>

  <style>
    .page-wrap{max-width:1080px;margin:24px auto;padding:0 16px}
    .h1{font-size:28px;margin:6px 0 4px}
    .lede{color:#4b5563;margin-bottom:14px}

    /* ===== Spotlight：聚焦單篇 ===== */
    .spotlight{display:grid;grid-template-columns:1.35fr 1fr;gap:18px;align-items:start;background:#fff;border:1px solid #e5e7eb;border-radius:14px;overflow:hidden}
    @media(max-width:920px){.spotlight{grid-template-columns:1fr}}
    .spotlight-hero{background:#0b0c0f}
    .spotlight-hero .frame{aspect-ratio:16/10;display:flex;align-items:center;justify-content:center}
    .spotlight-hero img{width:100%;height:100%;object-fit:contain;display:block}
    .spotlight-body{padding:16px 16px 12px}
    .spotlight-title{font-size:22px;line-height:1.35;margin:0 0 6px}
    .spotlight-meta{font-size:13px;color:#6b7280;margin-bottom:8px}
    .badge{display:inline-block;margin-left:6px;padding:2px 8px;border-radius:999px;background:#e5f2ff;color:#2563eb;font-size:12px;border:1px solid #bfdbfe}
    .spotlight-excerpt{margin:8px 0 8px;color:#374151}
    .tags{display:flex;flex-wrap:wrap;gap:6px;margin:6px 0 0}
    .tag{font-size:12px;padding:2px 8px;border-radius:999px;background:#f3f4f6;color:#374151}
    .spotlight-actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .btn{display:inline-block;text-align:center;padding:10px 12px;border-radius:10px;border:1px solid #d1d5db;background:#fff;color:#111827}
    .btn.primary{background:#111827;color:#fff;border-color:#111827}
    .btn.ghost{background:#fff}
    .navline{display:flex;gap:8px;align-items:center;margin:10px 0 0}
    .navline .sep{color:#cbd5e1}

    /* ===== 工具列（收斂版） ===== */
    .tools{margin:18px 0 8px}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .toolbar input[type="search"],.toolbar select{padding:10px 12px;border:1px solid #d1d5db;border-radius:8px}
    .toolbar input[type="search"]{flex:1;min-width:220px}

    /* 標籤 chips */
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 0}
    .chip{border:1px solid #d1d5db;border-radius:999px;padding:6px 12px;font-size:14px;background:#fff;color:#1f2937;cursor:pointer}
    .chip.active{background:#2563eb;color:#fff;border-color:#2563eb}

    /* 主清單（預設收起） */
    .grid-wrap{margin-top:14px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    @media(max-width:980px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.grid{grid-template-columns:1fr}}
    .card{border:1px solid #e5e7eb;border-radius:12px;background:#fff;overflow:hidden;display:flex;flex-direction:column}
    .thumb{aspect-ratio:16/10;background:#f8fafc;display:flex;align-items:center;justify-content:center}
    .thumb img{width:100%;height:100%;object-fit:contain;display:block}
    .card-body{padding:12px}
    .title{font-weight:700;line-height:1.35;margin:2px 0 6px}
    .meta{font-size:12px;color:#6b7280;margin-bottom:8px}
    .excerpt{font-size:13px;color:#374151;margin-top:6px}
    .actions{display:flex;gap:8px;margin-top:auto;padding:12px;border-top:1px solid #f3f4f6;background:#fafafa}

    /* 載入／空狀態 */
    .empty,.loading{padding:24px;border:1px dashed #cbd5e1;border-radius:12px;color:#475569;background:#f8fafc;margin:12px 0}

    /* 頂部導覽 */
    .compliance-links a{white-space:nowrap}
  </style>

  <!-- 固定麵包屑 JSON-LD -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"BreadcrumbList",
    "itemListElement":[
      {"@type":"ListItem","position":1,"name":"Home","item":"https://todays-tasks.com/"},
      {"@type":"ListItem","position":2,"name":"China Explore","item":"https://todays-tasks.com/index.html"}
    ]
  }
  </script>
</head>
<body>
  <!-- 頂部導覽（保留原連結） -->
  <div class="compliance-links" role="navigation" aria-label="Primary">
    <a href="/index.html" aria-current="page">Home</a> |
    <a href="/about.html">About</a> |
    <a href="/contact.html">Contact</a> |
    <a href="/privacy.html">Privacy Policy</a> |
    <a href="/productivity-tips.html">Productivity Tips</a> |
    <a href="/article2.html">Time Management</a> |
    <a href="/article3.html">Digital To-Do Lists</a> |
    <a href="/article4.html">How to Use</a> |
    <a href="/article5.html">Weekly Review</a> |
    <a href="/etsy-guides.html">Time-Saving</a> |
    <a href="/todo.html">To Do List</a>
  </div>

  <main class="page-wrap">
    <h1 class="h1">中國美食美景分享（China Explore）</h1>
    <p class="lede">首頁採用「聚焦單篇」設計：一次只看一則最值分享的內容，用最少思考就能做決定；需要時再展開完整清單與強力篩選。</p>

    <!-- ===== Spotlight：聚焦單篇 ===== -->
    <section id="spotlight" class="spotlight" aria-label="精選內容">
      <div class="spotlight-hero">
        <div class="frame" id="sl-img"></div>
      </div>
      <div class="spotlight-body">
        <h2 id="sl-title" class="spotlight-title"></h2>
        <div id="sl-meta" class="spotlight-meta"></div>
        <p id="sl-excerpt" class="spotlight-excerpt"></p>
        <div id="sl-tags" class="tags"></div>
        <div class="spotlight-actions">
          <a id="sl-link" class="btn primary" href="#" target="_blank" rel="noopener">查看詳情</a>
          <a id="sl-authority" class="btn ghost" href="#" target="_blank" rel="nofollow noopener">權威連結</a>
        </div>
        <div class="navline">
          <button id="prevBtn" class="btn">← 上一則</button>
          <span class="sep">|</span>
          <button id="nextBtn" class="btn">下一則 →</button>
          <span class="sep">|</span>
          <button id="randBtn" class="btn">隨機看看 🎲</button>
          <span class="sep">|</span>
          <button id="toggleListBtn" class="btn">顯示全部</button>
        </div>
      </div>
    </section>

    <!-- ===== 工具列（收斂版） ===== -->
    <section class="tools" aria-label="篩選工具">
      <div class="toolbar">
        <input id="q" type="search" placeholder="搜尋標題／摘要／內文／標籤…" aria-label="搜尋"/>
        <select id="citySel" aria-label="城市"><option value="">全部城市</option></select>
        <select id="provSel" aria-label="省份"><option value="">全部省份</option></select>
        <select id="kindSel" aria-label="類別">
          <option value="">全部類別</option>
          <option value="美食">美食</option>
          <option value="美景">美景</option>
        </select>
        <select id="sortSel" aria-label="排序">
          <option value="new">排序：最新</option>
          <option value="az">排序：A→Z</option>
        </select>
        <button id="refreshBtn" class="btn" type="button" title="重新抓取資料">Refresh</button>
      </div>
      <div id="tagChips" class="chips" aria-label="標籤"></div>
    </section>

    <!-- ===== 主清單（預設隱藏） ===== -->
    <section class="grid-wrap" id="gridWrap" hidden>
      <div id="status" class="loading" role="status">載入中…</div>
      <div id="grid" class="grid" aria-live="polite" hidden></div>
    </section>
  </main>

  <footer class="footer">© 2025 Today’s Tasks. All rights reserved.</footer>

  <script>
    // === 換成你的 JSON 端點 ===
    const FEED_URL = "https://script.google.com/macros/s/AKfycbwq5InzCeyUnW-GHe6bNqReMQMzWvwKe_pAZpD7ONHZ4LZrBdt8lgtpdxu1c57AaPx3ww/exec";

    // DOM 參照
    const q = document.getElementById('q');
    const citySel = document.getElementById('citySel');
    const provSel = document.getElementById('provSel');
    const kindSel = document.getElementById('kindSel');
    const sortSel = document.getElementById('sortSel');
    const refreshBtn = document.getElementById('refreshBtn');
    const tagChips = document.getElementById('tagChips');
    const gridWrap = document.getElementById('gridWrap');
    const statusEl = document.getElementById('status');
    const grid = document.getElementById('grid');
    const toggleListBtn = document.getElementById('toggleListBtn');

    // Spotlight DOM
    const slImg = document.getElementById('sl-img');
    const slTitle = document.getElementById('sl-title');
    const slMeta = document.getElementById('sl-meta');
    const slExcerpt = document.getElementById('sl-excerpt');
    const slTags = document.getElementById('sl-tags');
    const slLink = document.getElementById('sl-link');
    const slAuthority = document.getElementById('sl-authority');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const randBtn = document.getElementById('randBtn');

    // 狀態
    let RAW = [];
    let VIEW = [];   // 依篩選/排序後的結果
    let CUR = 0;     // Spotlight 目前索引
    let TAGS = new Set();
    let ACTIVE_TAG = "";

    // 啟動
    fetchFeed();

    // 事件
    q.addEventListener('input', rebuild);
    citySel.addEventListener('change', rebuild);
    provSel.addEventListener('change', rebuild);
    kindSel.addEventListener('change', rebuild);
    sortSel.addEventListener('change', rebuild);
    refreshBtn.addEventListener('click', ()=>fetchFeed(true));
    toggleListBtn.addEventListener('click', ()=>{
      gridWrap.hidden = !gridWrap.hidden;
      toggleListBtn.textContent = gridWrap.hidden ? '顯示全部' : '收起清單';
    });
    prevBtn.addEventListener('click', ()=> step(-1));
    nextBtn.addEventListener('click', ()=> step(+1));
    randBtn.addEventListener('click', ()=> { if (VIEW.length){ CUR = Math.floor(Math.random()*VIEW.length); renderSpotlight(); }});

    // 左右方向鍵切換
    window.addEventListener('keydown', (e)=>{
      if (e.key === 'ArrowLeft') step(-1);
      if (e.key === 'ArrowRight') step(+1);
    });

    // 讀取資料
    async function fetchFeed(noCache=false){
      try{
        statusEl.hidden=false; statusEl.textContent='載入中…'; grid.hidden=true;
        const url = noCache ? FEED_URL + (FEED_URL.includes('?')?'&':'?')+'t='+Date.now() : FEED_URL;
        const res = await fetch(url, {cache: noCache ? 'no-store':'default'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const json = await res.json();
        RAW = Array.isArray(json.items) ? json.items : [];
        normalize(RAW);
        buildFacets(RAW);
        rebuild(); // 會產生 VIEW 並渲染 Spotlight + (可選)清單
      }catch(err){
        statusEl.textContent = '讀取失敗：'+err.message;
      }
    }

    // 正規化
    function normalize(list){
      list.forEach(it=>{
        it.id = it.id ?? '';
        it.title = (it.title||'').toString();
        it.city = (it.city||'').toString();
        it.province = (it.province||'').toString();
        it.kind = (it.kind||'').toString();
        it.tags = Array.isArray(it.tags) ? it.tags : (it.tags ? it.tags.toString().split(',').map(s=>s.trim()).filter(Boolean) : []);
        it.image = (it.image||'').toString();
        it.link = (it.link||'').toString();
        it.excerpt = (it.excerpt||'').toString();
        it.content = (it.content||'').toString();
        it.created = it.created ? new Date(it.created) : new Date(0);
      });
    }

    // 篩選組建
    function buildFacets(list){
      const cities=[...new Set(list.map(x=>x.city).filter(Boolean))].sort();
      const provs =[...new Set(list.map(x=>x.province).filter(Boolean))].sort();
      fillSelect(citySel,["全部城市",...cities],["",...cities]);
      fillSelect(provSel,["全部省份",...provs],["",...provs]);

      TAGS = new Set(); list.forEach(x=>(x.tags||[]).forEach(t=>TAGS.add(t)));
      tagChips.innerHTML='';
      const all=chipEl('全部標籤',''); all.classList.add('active'); tagChips.appendChild(all);
      [...TAGS].sort().forEach(t=>tagChips.appendChild(chipEl(t,t)));
    }
    function fillSelect(sel,labels,values){
      sel.innerHTML=''; labels.forEach((lbl,i)=>{const o=document.createElement('option');o.textContent=lbl;o.value=values[i];sel.appendChild(o);});
    }
    function chipEl(text,value){
      const b=document.createElement('button'); b.type='button'; b.className='chip'; b.textContent=text; b.dataset.value=value;
      b.addEventListener('click',()=>{
        [...tagChips.querySelectorAll('.chip')].forEach(c=>c.classList.remove('active'));
        b.classList.add('active'); ACTIVE_TAG=value; rebuild();
      });
      return b;
    }

    // 重建 View（Spotlight 優先）
    function rebuild(){
      VIEW = RAW.slice();

      const term = q.value.trim().toLowerCase();
      if (citySel.value) VIEW = VIEW.filter(x=>x.city===citySel.value);
      if (provSel.value) VIEW = VIEW.filter(x=>x.province===provSel.value);
      if (kindSel.value) VIEW = VIEW.filter(x=>x.kind===kindSel.value);
      if (ACTIVE_TAG)   VIEW = VIEW.filter(x=>(x.tags||[]).includes(ACTIVE_TAG));
      if (term){
        VIEW = VIEW.filter(x=>{
          const hay=[x.title,x.excerpt,x.content,x.city,x.province,x.kind,...(x.tags||[])].join(' ').toLowerCase();
          return hay.includes(term);
        });
      }
      if (sortSel.value==='new') VIEW.sort((a,b)=>b.created-a.created);
      else if (sortSel.value==='az') VIEW.sort((a,b)=>a.title.localeCompare(b.title,'zh-Hant'));

      CUR = 0;
      renderSpotlight();
      renderList();
    }

    // Spotlight 渲染（＋預載下一張）
    function renderSpotlight(){
      const it = VIEW[CUR];
      if (!it){ slImg.innerHTML=''; slTitle.textContent='尚無內容'; slMeta.textContent=''; slExcerpt.textContent=''; slTags.innerHTML=''; slLink.style.display='none'; slAuthority.style.display='none'; injectPostJsonLd(null); return; }

      slImg.innerHTML = it.image ? `<img src="${escapeAttr(it.image)}" alt="${escapeAttr(it.title)}" loading="eager">`
                                 : `<div style="color:#9ca3af;font-size:12px">No image</div>`;
      slTitle.textContent = it.title || '';
      slMeta.innerHTML = `
        ${it.city?`<span>${escapeHTML(it.city)}</span>`:''}
        ${it.province?` · <span>${escapeHTML(it.province)}</span>`:''}
        ${it.kind?` · <span class="badge">${escapeHTML(it.kind)}</span>`:''}
        ${isValidDate(it.created)?` · <time datetime="${it.created.toISOString()}">${it.created.toLocaleDateString()}</time>`:''}
      `;
      slExcerpt.textContent = it.excerpt || '';
      slTags.innerHTML = (it.tags||[]).map(t=>`<span class="tag">${escapeHTML(t)}</span>`).join('');

      if (it.link){ slLink.href = it.link; slLink.style.display='inline-block'; } else { slLink.style.display='none'; }
      const auth = buildAuthorityLink(it);
      if (auth){ slAuthority.href = auth; slAuthority.style.display='inline-block'; } else { slAuthority.style.display='none'; }

      // JSON-LD 僅針對 Spotlight
      injectPostJsonLd(it);

      // 預載下一張
      if (VIEW.length>1){
        const nxt = VIEW[(CUR+1)%VIEW.length];
        if (nxt && nxt.image){ const img = new Image(); img.src = nxt.image; }
      }
    }
    function isValidDate(d){ return d instanceof Date && !isNaN(d); }

    function step(delta){
      if (!VIEW.length) return;
      CUR = (CUR + delta + VIEW.length) % VIEW.length;
      renderSpotlight();
    }

    function buildAuthorityLink(x){
      const q = encodeURIComponent((x.city?x.city+' ':'') + (x.title||''));
      if (x.kind === '美食') return `https://www.dianping.com/search/keyword/2/0_${q}`;
      if (x.kind === '美景') return `https://www.tripadvisor.com/Search?q=${q}`;
      return '';
    }

    // 主清單（備選：顯示全部）
    function renderList(){
      if (!VIEW.length){ grid.hidden=true; statusEl.hidden=false; statusEl.className='empty'; statusEl.textContent='沒有符合條件的內容。'; return; }
      const html = VIEW.map(x=>cardHTML(x)).join('');
      grid.innerHTML = html; statusEl.hidden=true; grid.hidden=false;
    }
    function cardHTML(x){
      const dateStr = isValidDate(x.created) ? x.created.toLocaleDateString() : '';
      const img = x.image ? `<img src="${escapeAttr(x.image)}" alt="${escapeAttr(x.title)}" loading="lazy">` : `<div style="font-size:12px;color:#6b7280">No image</div>`;
      const tags = (x.tags||[]).map(t=>`<span class="tag">${escapeHTML(t)}</span>`).join('');
      const linkBtn = x.link ? `<a class="btn primary" href="${escapeAttr(x.link)}" target="_blank" rel="noopener">查看詳情</a>` : '';
      const auth = buildAuthorityLink(x);
      return `
        <article class="card">
          <div class="thumb">${img}</div>
          <div class="card-body">
            <h3 class="title">${escapeHTML(x.title)}</h3>
            <div class="meta">
              ${x.city?`<span>${escapeHTML(x.city)}</span>`:''}
              ${x.province?` · <span>${escapeHTML(x.province)}</span>`:''}
              ${x.kind?` · <span class="badge">${escapeHTML(x.kind)}</span>`:''}
              ${dateStr?` · <span>${dateStr}</span>`:''}
            </div>
            ${x.excerpt?`<p class="excerpt">${escapeHTML(x.excerpt)}</p>`:''}
            ${tags?`<div class="tags">${tags}</div>`:''}
          </div>
          <div class="actions">
            ${linkBtn}
            ${auth?`<a class="btn" href="${auth}" target="_blank" rel="nofollow noopener">權威連結</a>`:''}
            <button class="btn" onclick="jumpTo('${escapeAttr(x.id)}')">在上方顯示</button>
          </div>
        </article>
      `;
    }
    // 從清單跳到 Spotlight
    window.jumpTo = function(id){
      const idx = VIEW.findIndex(x=>String(x.id)===String(id));
      if (idx>=0){ CUR=idx; renderSpotlight(); window.scrollTo({top:0,behavior:'smooth'}); }
    }

    // JSON-LD：動態注入 Spotlight 的 BlogPosting
    function injectPostJsonLd(it){
      // 清除舊的
      document.querySelectorAll('script[data-spotlight-jsonld="1"]').forEach(n=>n.remove());
      if (!it) return;
      const obj = {
        "@context":"https://schema.org",
        "@type":"BlogPosting",
        "headline": it.title || "",
        "image": it.image ? [it.image] : undefined,
        "datePublished": isValidDate(it.created) ? it.created.toISOString() : undefined,
        "author": {"@type":"Person","name":"Hill"},
        "publisher":{"@type":"Organization","name":"Today's Tasks"},
        "articleSection": it.kind || "",
        "description": it.excerpt || "",
        "mainEntityOfPage": it.link || "https://todays-tasks.com/index.html"
      };
      const s=document.createElement('script'); s.type='application/ld+json'; s.dataset.spotlightJsonld='1'; s.textContent=JSON.stringify(obj);
      document.head.appendChild(s);
    }

    // 小工具
    function escapeHTML(s){return (s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));}
    function escapeAttr(s){return escapeHTML(s);}
  </script>
</body>
</html>
