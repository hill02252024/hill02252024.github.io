<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>中國美食美景分享｜China Explore</title>
  <meta name="description" content="精選一篇中國內地旅行的美食或美景介紹，圖文精要、外部權威連結、上一則／下一則快速切換。"/>

  <link rel="stylesheet" href="/style.css"/>

  <style>
    :root{
      --fg:#111827;--muted:#6b7280;--line:#e5e7eb;--chip:#f3f4f6;--bg:#fff;--accent:#111827;
    }
    body{color:var(--fg)}
    .page-wrap{max-width:980px;margin:24px auto;padding:0 16px}
    .h1{font-size:28px;margin:6px 0 4px}
    .lede{color:#4b5563;margin:0 0 14px}

    /* Hero 單篇卡 */
    .hero{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
    .hero-media{aspect-ratio:16/10;background:#f8fafc;display:flex;align-items:center;justify-content:center}
    .hero-media img{width:100%;height:100%;object-fit:contain;display:block}
    .hero-body{padding:16px}
    .title{font-weight:800;line-height:1.28;margin:0 0 8px;font-size:22px}
    .meta{font-size:13px;color:var(--muted);display:flex;flex-wrap:wrap;gap:8px;margin:0 0 10px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#e5f2ff;color:#2563eb;
      font-size:12px;border:1px solid #bfdbfe}
    .excerpt{font-size:15px;line-height:1.6;margin:8px 0 8px}
    .content{font-size:15px;line-height:1.8;margin:8px 0 4px;white-space:pre-wrap}
    .tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .tag{font-size:12px;padding:2px 8px;border-radius:999px;background:var(--chip);color:#374151}
    .bio{margin:12px 0 0;font-size:12px;color:var(--muted)}
    .actions{display:flex;flex-wrap:wrap;gap:10px;margin:14px 0 0}
    .btn{display:inline-block;text-align:center;padding:10px 14px;border-radius:10px;border:1px solid var(--line);
      background:#fff;color:var(--fg);text-decoration:none}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn.ghost{background:#fafafa}

    /* 上一則 / 下一則工具列 */
    .navrail{display:flex;justify-content:space-between;gap:8px;margin:12px 0}
    .pill{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;color:var(--fg);
      text-decoration:none;font-size:13px}
    .pill:focus{outline:2px solid #2563eb;outline-offset:2px}

    .loading,.empty{padding:18px;border:1px dashed #cbd5e1;border-radius:12px;background:#f8fafc;color:#475569;margin:12px 0}

    @media (max-width:640px){
      .title{font-size:20px}
      .content,.excerpt{font-size:14px}
    }
  </style>

  <!-- 麵包屑（首頁） -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"BreadcrumbList",
    "itemListElement":[
      {"@type":"ListItem","position":1,"name":"Home","item":"https://todays-tasks.com/"},
      {"@type":"ListItem","position":2,"name":"China Explore","item":"https://todays-tasks.com/index.html"}
    ]
  }
  </script>
</head>
<body>
  <!-- 導覽列 -->
  <div class="compliance-links" role="navigation" aria-label="Primary">
    <a href="/index.html" aria-current="page">Home</a> |
    <a href="/about.html">About</a> |
    <a href="/contact.html">Contact</a> |
    <a href="/privacy.html">Privacy Policy</a> |
    <a href="/productivity-tips.html">Productivity Tips</a> |
    <a href="/article2.html">Time Management</a> |
    <a href="/article3.html">Digital To-Do Lists</a> |
    <a href="/article4.html">How to Use</a> |
    <a href="/article5.html">Weekly Review</a> |
    <a href="/etsy-guides.html">Time-Saving</a> |
    <a href="/todo.html">To Do List</a>
  </div>

  <main class="page-wrap">
    <h1 class="h1">中國美食美景分享（China Explore）</h1>
    <p class="lede">一次只看一篇：圖片大、資訊精、上一則／下一則秒切換。支援 URL 指定 <code>?id=數字</code> 或 <code>?n=索引</code>。</p>

    <div id="rail" class="navrail" hidden>
      <a id="prevBtn" class="pill" href="#">← 上一則</a>
      <a id="nextBtn" class="pill" href="#">下一則 →</a>
    </div>

    <section id="stage" class="hero" aria-live="polite" hidden></section>
    <div id="status" class="loading">載入中…</div>

    <div class="actions" style="margin-top:12px">
      <a class="btn" href="/china-explore.html">回到清單</a>
      <a class="btn ghost" id="randomBtn" href="#">隨機看一則</a>
      <a class="btn ghost" id="refreshBtn" href="#">重新整理</a>
    </div>
  </main>

  <footer class="footer">© 2025 Today’s Tasks. All rights reserved.</footer>

  <script>
    // === 你的 Google Apps Script JSON 端點 ===
    const FEED_URL = "https://script.google.com/macros/s/AKfycbwq5InzCeyUnW-GHe6bNqReMQMzWvwKe_pAZpD7ONHZ4LZrBdt8lgtpdxu1c57AaPx3ww/exec";

    // DOM 參照
    const stage = document.getElementById('stage');
    const statusEl = document.getElementById('status');
    const rail = document.getElementById('rail');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const randomBtn = document.getElementById('randomBtn');
    const refreshBtn = document.getElementById('refreshBtn');

    // 狀態
    let LIST = [];        // 正規化後的所有項目（照時間新→舊）
    let INDEX = 0;        // 目前顯示的索引

    // 啟動
    init();
    async function init(){
      await fetchFeed();
      // 依 URL 參數決定顯示哪一筆
      const url = new URL(location.href);
      const idParam = url.searchParams.get('id');
      const nParam = url.searchParams.get('n');

      if (idParam){
        const idx = LIST.findIndex(x => String(x.id) === String(idParam));
        INDEX = idx >= 0 ? idx : 0;
      } else if (nParam){
        const n = parseInt(nParam,10);
        INDEX = isFinite(n) && n>=0 && n<LIST.length ? n : 0;
      } else {
        INDEX = 0; // 預設最新一筆
      }
      renderAt(INDEX);
    }

    // 讀取資料
    async function fetchFeed(noCache=false){
      statusEl.hidden = false;
      statusEl.textContent = "載入中…";
      stage.hidden = true;
      rail.hidden = true;

      const url = noCache ? FEED_URL + (FEED_URL.includes('?')?'&':'?') + 't=' + Date.now() : FEED_URL;
      const res = await fetch(url, {cache: noCache? 'no-store':'default'});
      if(!res.ok){ statusEl.textContent = "讀取失敗：" + res.status; return; }
      const json = await res.json();
      const items = Array.isArray(json.items)? json.items : [];

      LIST = normalize(items).sort((a,b)=> b.created - a.created); // 最新在前
      if(!LIST.length){
        statusEl.className = "empty";
        statusEl.textContent = "目前尚無內容。";
        return;
      }
    }

    // 正規化
    function normalize(list){
      return list.map(r=>{
        return {
          id: r.id ?? "",
          title: String(r.title||""),
          city: String(r.city||""),
          province: String(r.province||""),
          kind: String(r.kind||""),
          tags: Array.isArray(r.tags)? r.tags : (r.tags? String(r.tags).split(",").map(s=>s.trim()).filter(Boolean):[]),
          image: String(r.image||""),
          link: String(r.link||""),
          excerpt: String(r.excerpt||""),
          content: String(r.content||""),
          created: r.created ? new Date(r.created) : new Date(0)
        }
      });
    }

    // 依索引渲染
    function renderAt(i){
      if(!LIST.length) return;
      INDEX = ((i % LIST.length) + LIST.length) % LIST.length; // 循環
      const x = LIST[INDEX];

      stage.innerHTML = heroHTML(x);
      statusEl.hidden = true;
      stage.hidden = false;

      // 導覽列
      rail.hidden = false;
      prevBtn.href = buildLink(INDEX-1);
      nextBtn.href = buildLink(INDEX+1);

      // 預先載入下一張圖片，切換體感更快
      const preloadIdx = (INDEX+1) % LIST.length;
      if (LIST[preloadIdx].image){
        const img = new Image();
        img.src = LIST[preloadIdx].image;
      }

      // 更新 URL（不重整）
      const url = new URL(location.href);
      if (x.id) { url.searchParams.set('id', x.id); url.searchParams.delete('n'); }
      else { url.searchParams.set('n', INDEX); url.searchParams.delete('id'); }
      history.replaceState(null, "", url);

      // 注入單篇 JSON-LD
      injectJsonLdForPost(x);
    }

    // 產出 hero HTML
    function heroHTML(x){
      const dateStr = x.created instanceof Date && !isNaN(x.created) ? x.created.toLocaleDateString() : "";
      const tags = (x.tags||[]).map(t=>`<span class="tag">${esc(t)}</span>`).join("");
      const auth = authorityLink(x);

      return `
        <article class="hero" itemscope itemtype="https://schema.org/BlogPosting">
          <div class="hero-media">
            ${x.image ? `<img src="${att(x.image)}" alt="${att(x.title||x.city||'Photo')}" loading="eager" fetchpriority="high">`
                       : `<div style="font-size:12px;color:#6b7280">No image</div>`}
          </div>
          <div class="hero-body">
            <h2 class="title" itemprop="headline">${esc(x.title)}</h2>
            <div class="meta">
              ${x.city?`<span itemprop="contentLocation">${esc(x.city)}</span>`:""}
              ${x.province?`<span>· ${esc(x.province)}</span>`:""}
              ${x.kind?`<span class="badge">${esc(x.kind)}</span>`:""}
              ${dateStr?`<span>· ${dateStr}</span>`:""}
            </div>
            ${x.excerpt?`<p class="excerpt" itemprop="description">${esc(x.excerpt)}</p>`:""}
            ${x.content?`<div class="content" itemprop="articleBody">${esc(x.content)}</div>`:""}
            ${tags?`<div class="tags" aria-label="標籤">${tags}</div>`:""}

            <div class="actions">
              ${x.link?`<a class="btn primary" href="${att(x.link)}" target="_blank" rel="noopener">查看詳情</a>`:""}
              ${auth}
              <a class="btn" href="/china-explore.html">回到清單</a>
            </div>

            <p class="bio">作者：Hill｜原創實拍與在地體驗筆記。未經授權請勿轉載（© Today’s Tasks）。</p>
          </div>
        </article>
      `;
    }

    // 權威連結
    function authorityLink(x){
      const q = encodeURIComponent(`${x.city?x.city+" ":""}${x.title||""}`);
      if (x.kind === "美食"){
        return `<a class="btn ghost" href="https://www.dianping.com/search/keyword/2/0_${q}" target="_blank" rel="nofollow noopener">權威連結：大眾點評</a>`;
      }
      return `<a class="btn ghost" href="https://www.tripadvisor.com/Search?q=${q}" target="_blank" rel="nofollow noopener">權威連結：TripAdvisor</a>`;
    }

    // 產出上一則/下一則的網址
    function buildLink(i){
      i = ((i % LIST.length) + LIST.length) % LIST.length;
      const x = LIST[i];
      return x.id ? `?id=${encodeURIComponent(x.id)}` : `?n=${i}`;
    }

    // JSON-LD for 單篇；從資料自動帶入
    function injectJsonLdForPost(x){
      // 先移除舊的
      document.querySelectorAll('script[data-post-jsonld="1"]').forEach(n=>n.remove());
      const obj = {
        "@context":"https://schema.org",
        "@type":"BlogPosting",
        "headline": x.title || "",
        "image": x.image ? [x.image] : undefined,
        "datePublished": x.created? new Date(x.created).toISOString() : undefined,
        "author":{"@type":"Person","name":"Hill"},
        "publisher":{"@type":"Organization","name":"Today's Tasks"},
        "articleSection": x.kind || "",
        "description": x.excerpt || "",
        "mainEntityOfPage": location.href
      };
      const s = document.createElement('script');
      s.type = "application/ld+json";
      s.dataset.postJsonld = "1";
      s.textContent = JSON.stringify(obj);
      document.head.appendChild(s);
    }

    // 工具
    function esc(s){return (s||"").replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]))}
    function att(s){return esc(s)}

    // 事件：上一則 / 下一則 / 隨機 / 重新整理 / 鍵盤
    prevBtn.addEventListener('click', e=>{
      e.preventDefault(); renderAt(INDEX-1);
    });
    nextBtn.addEventListener('click', e=>{
      e.preventDefault(); renderAt(INDEX+1);
    });
    randomBtn.addEventListener('click', e=>{
      e.preventDefault(); renderAt(Math.floor(Math.random()*LIST.length));
    });
    refreshBtn.addEventListener('click', e=>{
      e.preventDefault(); fetchFeed(true).then(()=>renderAt(INDEX));
    });
    window.addEventListener('keydown', e=>{
      if(e.key==="ArrowLeft") renderAt(INDEX-1);
      if(e.key==="ArrowRight") renderAt(INDEX+1);
    });
  </script>
</body>
</html>
